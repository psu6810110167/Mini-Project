import React, { useState, useEffect } from 'react';
import axios from 'axios';
// import { useAuth } from './context/AuthContext'; 
import './AdminScreen.css'; 

// ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏à‡∏≥‡∏•‡∏≠‡∏á Auth ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
const useAuth = () => ({
  adminSecret: 'mySuperSecretPassword', 
  logout: () => window.location.href = '/'
});

interface Menu {
  id: number;
  name: string;
  price: number;
  isAvailable: boolean;
  image: string;
}

const AdminScreen: React.FC = () => {
  const { adminSecret, logout } = useAuth();
  
  const [menus, setMenus] = useState<Menu[]>([]); // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
  const [formData, setFormData] = useState({
    name: '',
    price: 0,
    isAvailable: true,
    image: ''
  });
  const [isLoading, setIsLoading] = useState(false);

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏ô‡∏π (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)
  const fetchMenus = async () => {
    try {
      const response = await axios.get('http://localhost:3000/api/menus');
      setMenus(response.data);
    } catch (error) {
      console.error('Error fetching menus:', error);
    }
  };

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
  useEffect(() => {
    fetchMenus();
  }, []);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : (name === 'price' ? Number(value) : value)
    }));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!formData.name || formData.price <= 0) return alert('‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö');

    try {
      setIsLoading(true);
      await axios.post('http://localhost:3000/api/menus', formData, {
        headers: { 'admin-secret': adminSecret }
      });
      alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
      setFormData({ name: '', price: 0, isAvailable: true, image: '' });
      fetchMenus(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°
    } catch (error: any) {
      if (error.response && error.response.data && error.response.data.message) {
        alert(error.response.data.message);
      } else {
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
      }
    } finally {
      setIsLoading(false);
    }
  };

  // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π (‡∏û‡∏£‡∏∞‡πÄ‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ)
  const handleDelete = async (id: number) => {
    // 1. ‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö ‡∏Å‡∏±‡∏ô‡∏°‡∏∑‡∏≠‡∏•‡∏±‡πà‡∏ô
    if (!window.confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡πÑ‡∏´‡∏°‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ? ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏∞!')) return;

    try {
      // 2. ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡πÑ‡∏õ Backend
      await axios.delete(`http://localhost:3000/api/menus/${id}`, {
        headers: { 'admin-secret': adminSecret }
      });

      // 3. ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà
      fetchMenus();
      
    } catch (error) {
      console.error('Error deleting:', error);
      alert('‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  };

  return (
    <div className="admin-container">
      <div className="admin-header">
        <h1>üë®‚Äçüç≥ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>
        <button onClick={logout} className="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>

      <div className="admin-content-wrapper" style={{ display: 'flex', gap: '20px', flexWrap: 'wrap' }}>
        
        {/* ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢) */}
        <div className="admin-card" style={{ flex: 1, minWidth: '300px' }}>
          <h3 style={{ marginTop: 0, color: '#555' }}>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h3>
          <form onSubmit={handleSubmit}>
            <div className="form-group">
              <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</label>
              <input type="text" name="name" value={formData.name} onChange={handleChange} required />
            </div>
            <div className="form-group">
              <label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó):</label>
              <input type="number" name="price" value={formData.price} onChange={handleChange} min="1" required />
            </div>
            <div className="form-group">
              <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL):</label>
              <input type="text" name="image" value={formData.image} onChange={handleChange} />
            </div>
            <div className="form-group checkbox-group">
              <label>
                <input type="checkbox" name="isAvailable" checked={formData.isAvailable} onChange={handleChange} />
                <span>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</span>
              </label>
            </div>
            <button type="submit" disabled={isLoading} className="submit-btn">
              {isLoading ? '‚è≥...' : 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏ô‡∏π'}
            </button>
          </form>
        </div>

        {/* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) */}
        <div className="admin-list" style={{ flex: 2, minWidth: '300px' }}>
          <h3>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({menus.length})</h3>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '15px' }}>
            {menus.map(menu => (
              <div key={menu.id} className="menu-item-card">
                <img src={menu.image || 'https://via.placeholder.com/150'} alt={menu.name} />
                <div className="menu-info">
                  <h4>{menu.name}</h4>
                  <p>‡∏ø{menu.price}</p>
                  
                  {/* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏™‡∏µ‡πÅ‡∏î‡∏á */}
                  <button 
                    onClick={() => handleDelete(menu.id)} 
                    className="delete-btn"
                  >
                    üóëÔ∏è ‡∏•‡∏ö
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>

      </div>
    </div>
  );
};

export default AdminScreen;